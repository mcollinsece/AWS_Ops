{
    "schemaVersion": "2.2",
    "description": "Disable vulnerable ciphers and HMACs to mitigate CVE-2023-48795 on RHEL 8 instances",
    "mainSteps": [
      {
        "action": "aws:runShellScript",
        "name": "DisableVulnerableCiphersAndHMACs",
        "inputs": {
          "runCommand": [
            "echo 'cipher@SSH = -CHACHA20-POLY1305\nssh_etm = 0' > /etc/crypto-policies/policies/modules/CVE-2023-48795.pmod",
            "update-crypto-policies --set $(update-crypto-policies --show):CVE-2023-48795",
            "systemctl restart sshd",
            "if ! grep -q 'chacha20-poly1305@openssh.com' /etc/crypto-policies/back-ends/openssh.config; then echo 'chacha20-poly1305@openssh.com cipher disabled successfully'; else echo 'Failed to disable chacha20-poly1305@openssh.com cipher'; fi",
            "if ! grep -q 'hmac-sha2-512-etm@openssh.com' /etc/crypto-policies/back-ends/openssh.config; then echo 'hmac-sha2-512-etm@openssh.com HMAC disabled successfully'; else echo 'Failed to disable hmac-sha2-512-etm@openssh.com HMAC'; fi",
            "if ! grep -q 'hmac-sha2-256-etm@openssh.com' /etc/crypto-policies/back-ends/openssh.config; then echo 'hmac-sha2-256-etm@openssh.com HMAC disabled successfully'; else echo 'Failed to disable hmac-sha2-256-etm@openssh.com HMAC'; fi",
            "if ! grep -q 'hmac-sha1-etm@openssh.com' /etc/crypto-policies/back-ends/openssh.config; then echo 'hmac-sha1-etm@openssh.com HMAC disabled successfully'; else echo 'Failed to disable hmac-sha1-etm@openssh.com HMAC'; fi",
            "if ! grep -q 'hmac-md5-etm@openssh.com' /etc/crypto-policies/back-ends/openssh.config; then echo 'hmac-md5-etm@openssh.com HMAC disabled successfully'; else echo 'Failed to disable hmac-md5-etm@openssh.com HMAC'; fi"
          ]
        }
      }
    ]
  }
  